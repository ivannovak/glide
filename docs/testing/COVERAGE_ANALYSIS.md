# Test Coverage Analysis

**Date:** 2025-11-28
**Phase:** Phase 2: Testing Infrastructure
**Current Overall Coverage:** 26.8%
**Target Overall Coverage:** 80%+

## Executive Summary

This document provides a comprehensive analysis of test coverage across the Glide codebase, identifies critical gaps, categorizes untested code, and provides a prioritized test plan for achieving the 80%+ coverage target.

### Key Findings

- **Overall Coverage:** 26.8% (need +53.2% to reach target)
- **Critical Packages:** 7 packages with <40% coverage require immediate attention
- **Untested Functions:** ~900 out of 1,354 functions (66.5%) are untested
- **Generated Code:** ~200 functions are protobuf-generated (lower priority)
- **Critical Paths:** ~400 functions in security-critical and core functionality paths

### Risk Assessment

- **HIGH RISK:** Plugin SDK (8.6% coverage) - security and stability critical
- **HIGH RISK:** CLI (12.1% coverage) - user-facing, error handling gaps
- **MEDIUM RISK:** Config (26.7%), Errors (38.6%), Output (35.3%) - core functionality
- **LOW RISK:** Prompt (6.0%) - UI component, less critical

---

## Package-by-Package Analysis

### CRITICAL PRIORITY (P0)

#### 1. pkg/plugin/sdk/v1 (8.6% coverage)

**Current State:**
- Total functions: 191
- Untested: 187 (98%)
- Current coverage: 8.6%
- **Target:** 80%+ (need +71.4%)

**Files:**
```
base_plugin.go              - Plugin lifecycle and command execution
base_plugin_test.go         - Existing tests (minimal)
interactive.go              - Interactive command execution
interactive_unix.go         - Unix-specific TTY handling
interactive_windows.go      - Windows-specific handling
plugin.pb.go               - [GENERATED] Protobuf message types
plugin_grpc.pb.go          - [GENERATED] gRPC service definitions
plugin_types.go            - Core plugin types and interfaces
pty_unix.go                - PTY operations (Unix)
pty_windows.go             - PTY operations (Windows)
categories.go              - Plugin categorization
```

**Untested Critical Paths:**

1. **Interactive Execution (CRITICAL - Security)**
   - `ExecuteDockerInteractive()` - Docker container interaction
   - `ExecuteLocalInteractive()` - Local process interaction
   - `RunInteractiveLoop()` - I/O loop with signal handling
   - `handleSignal()` - Signal propagation to child processes
   - `handleResize()` - Terminal resize handling
   - **Risk:** Improper signal handling could lead to zombie processes or security issues

2. **Plugin Communication (CRITICAL - Stability)**
   - `Send()` / `Recv()` - Interactive message exchange
   - `Close()` - Cleanup and resource management
   - `RunDockerExec()` - Docker exec integration
   - `RunDockerCompose()` - Docker Compose integration
   - `RunLocal()` - Local command execution
   - **Risk:** Resource leaks, deadlocks, or protocol violations

3. **PTY Management (CRITICAL - Platform-specific)**
   - `startWithPTY()` - PTY allocation and setup
   - `setPTYSize()` - Terminal dimension management
   - **Risk:** Terminal corruption, TTY leaks

4. **Generated Code (LOW PRIORITY)**
   - All functions in `plugin.pb.go` and `plugin_grpc.pb.go` (~150 functions)
   - **Risk:** Low - generated by protoc, tested by protocol buffer library
   - **Recommendation:** Add protocol-level tests instead of unit tests

**Test Plan:**

- **Phase 2.2.1:** Plugin validation tests (6h)
- **Phase 2.2.2:** Plugin lifecycle tests (6h)
- **Phase 2.2.3:** Plugin communication tests (6h)
- **Phase 2.2.4:** SDK contract tests (6h)
- **Est. Coverage After:** 80%+ (excluding generated code)

**Dependencies:**
- Docker installed (for Docker interaction tests)
- TTY available (for interactive tests)
- Mock gRPC clients/servers

---

#### 2. internal/cli (12.1% coverage)

**Current State:**
- Total functions: 177
- Untested: 160 (90%)
- Current coverage: 12.1%
- **Target:** 80%+ (need +67.9%)

**Files:**
```
base.go                - Base command structure
builder.go             - Command tree builder
cli.go                 - CLI implementation
completion.go          - Shell completion (bash/zsh/fish)
config.go              - Config management commands
debug.go               - Debug commands
framework_commands.go  - Framework-specific command injection
help.go                - Help system
mode_helpers.go        - Mode validation helpers
plugins.go             - Plugin management commands
```

**Untested Critical Paths:**

1. **Command Registration (CRITICAL)**
   - `registerCommands()` - Command tree construction
   - `loadYAMLCommands()` - YAML command discovery
   - `registerCompletions()` - Completion registration
   - `isProtectedCommand()` - Protection check for overrides
   - **Risk:** Command conflicts, YAML injection, broken help

2. **Completion System (HIGH)**
   - `GenerateCompletion()` - Completion script generation
   - `InstallCompletion()` - Installation to shell rc files
   - `getContainerCompletions()` - Dynamic Docker completions
   - `getBranchCompletions()` - Git branch completions
   - `RegisterCommandCompletions()` - Custom completion registration
   - **Risk:** Broken shell integration, invalid completions

3. **Config Commands (HIGH)**
   - `runGet()` - Config value retrieval
   - `runSet()` - Config value modification
   - `runList()` - Config listing
   - `getValue()` / `setValue()` - Config manipulation
   - `save()` - Persist config changes
   - **Risk:** Config corruption, invalid values

4. **Help System (MEDIUM)**
   - `ShowHelp()` - Help rendering
   - `showGettingStarted()` - Onboarding help
   - `showWorkflows()` - Workflow documentation
   - `showCommandHelp()` - Command-specific help
   - **Risk:** Confusing UX, missing documentation

5. **Plugin Commands (HIGH)**
   - `installFromGitHub()` - GitHub plugin installation
   - `installFromFile()` - Local plugin installation
   - `isGitHubURL()` - URL validation
   - **Risk:** Security - arbitrary code execution

6. **Framework Commands (MEDIUM)**
   - `InjectCommands()` - Dynamic command injection
   - `executeFrameworkCommand()` - Framework-aware execution
   - `expandArguments()` - Argument expansion
   - **Risk:** Command injection, unexpected behavior

**Test Plan:**

- **Phase 2.3.1:** Command registration tests (5h)
- **Phase 2.3.2:** Command execution tests (6h)
- **Phase 2.3.3:** Error handling tests (5h)
- **Phase 2.3.4:** Help system tests (4h)
- **Est. Coverage After:** 80%+

**Dependencies:**
- Mock plugin registry
- Temporary config files
- Shell environment (for completion tests)

---

#### 3. pkg/plugin/sdk (17.5% coverage)

**Current State:**
- Total functions: 274
- Untested: 264 (96%)
- Current coverage: 17.5%
- **Target:** 80%+ (need +62.5%)

**Untested Critical Paths:**

1. **Plugin Validation**
   - Plugin info validation (name, version, dependencies)
   - Security validation (path traversal, permissions)
   - Binary validation (magic numbers, format)

2. **Plugin Protocol**
   - Magic number exchange
   - Version negotiation
   - Capability negotiation

3. **Plugin Lifecycle**
   - Initialization
   - Registration
   - Execution
   - Cleanup

**Test Plan:** Covered in Phase 2.2 (Plugin SDK Testing)

---

#### 4. pkg/prompt (6.0% coverage)

**Current State:**
- Total functions: 20
- Untested: 20 (100%)
- Current coverage: 6.0%
- **Target:** 80%+ (need +74%)

**Files:**
```
input.go      - Text/password input
select.go     - Selection prompts
validation.go - Input validation
```

**Untested Critical Paths:**

1. **Input Prompts**
   - Text input with validation
   - Password input (hidden)
   - Confirmation prompts (Y/n)

2. **Selection Prompts**
   - Single select
   - Multi select
   - Fuzzy search

3. **Validation**
   - Required input
   - Pattern validation
   - Custom validators

4. **Interactive Mode**
   - TTY detection
   - Non-interactive fallback

**Test Plan:** Phase 2.4.4 (6h)

**Dependencies:**
- TTY emulation for testing
- Input simulation

---

### HIGH PRIORITY (P1)

#### 5. internal/config (26.7% coverage)

**Current State:**
- Total functions: 31
- Untested: 26 (84%)
- Current coverage: 26.7%
- **Target:** 80%+ (need +53.3%)

**Untested Critical Paths:**

1. **Config Discovery**
   - `.glide.yml` file discovery
   - Parent directory traversal
   - Home directory fallback
   - Multi-config merging

2. **Config Loading**
   - YAML parsing
   - Schema validation
   - Default value application
   - Environment variable overrides

3. **Config Validation**
   - Required field checks
   - Type validation
   - Cross-field validation

**Test Plan:** Phase 2.4.1 (6h)

---

#### 6. pkg/errors (38.6% coverage)

**Current State:**
- Total functions: 52
- Untested: 51 (98%)
- Current coverage: 38.6%
- **Target:** 80%+ (need +41.4%)

**Untested Critical Paths:**

1. **Error Types**
   - GlideError (base type)
   - UserError (user-facing)
   - SystemError (internal)
   - PluginError (plugin-specific)

2. **Error Wrapping**
   - `Wrap()` / `Wrapf()` - Error context
   - `WithSuggestion()` - Actionable suggestions
   - `Unwrap()` chain traversal

3. **Error Formatting**
   - Error messages
   - Suggestion formatting
   - Stack trace inclusion

**Test Plan:** Phase 2.4.2 (6h)

---

#### 7. pkg/output (35.3% coverage)

**Current State:**
- Total functions: 109
- Untested: 92 (84%)
- Current coverage: 35.3%
- **Target:** 80%+ (need +44.7%)

**Untested Critical Paths:**

1. **Output Formatting**
   - Plain text
   - JSON
   - YAML
   - Table format

2. **Output Levels**
   - Debug, Info, Warning, Error, Success
   - Level filtering
   - Color formatting

3. **Progress Indicators**
   - Spinner
   - Progress bar
   - Multi-progress

4. **Output Writers**
   - Stdout/stderr routing
   - File output
   - Buffer capture

**Test Plan:** Phase 2.4.3 (6h)

---

## Coverage by Category

### By Priority

| Priority | Packages | Current Avg | Target | Gap |
|----------|----------|-------------|--------|-----|
| P0 (CRITICAL) | 4 | 11.1% | 80%+ | +68.9% |
| P1 (HIGH) | 3 | 33.5% | 80%+ | +46.5% |
| P2 (MEDIUM) | 6 | 60.8% | 70%+ | +9.2% |
| DONE (>80%) | 7 | 87.5% | 80%+ | ✅ |

### By Function Count

| Package | Total Funcs | Untested | % Untested |
|---------|-------------|----------|------------|
| pkg/plugin/sdk | 274 | 264 | 96% |
| pkg/plugin/sdk/v1 | 191 | 187 | 98% |
| internal/cli | 177 | 160 | 90% |
| pkg/output | 109 | 92 | 84% |
| pkg/errors | 52 | 51 | 98% |
| internal/config | 31 | 26 | 84% |
| pkg/prompt | 20 | 20 | 100% |
| **TOTAL CRITICAL** | **854** | **800** | **94%** |

---

## Categorization of Untested Code

### 1. Critical Paths (MUST TEST - P0)

**Definition:** Code paths that handle security, error conditions, or core functionality.

**Examples:**
- Plugin execution and lifecycle
- YAML command sanitization
- Config validation
- Error handling and propagation
- Interactive session management

**Count:** ~400 functions
**Priority:** P0
**Target Coverage:** 90%+

### 2. Edge Cases (SHOULD TEST - P1)

**Definition:** Boundary conditions, error states, unusual inputs.

**Examples:**
- Empty config files
- Malformed YAML
- Plugin conflicts
- Terminal resize during interaction
- Network timeouts

**Count:** ~200 functions
**Priority:** P1
**Target Coverage:** 80%+

### 3. Happy Paths (NICE TO HAVE - P2)

**Definition:** Normal operation flows with valid inputs.

**Examples:**
- Standard command execution
- Config loading with valid YAML
- Help display
- Plugin listing

**Count:** ~150 functions
**Priority:** P2
**Target Coverage:** 70%+

### 4. Generated Code (LOW PRIORITY)

**Definition:** Protobuf-generated code, auto-generated stubs.

**Examples:**
- All functions in `*.pb.go` files
- gRPC service stubs
- Protobuf message getters/setters

**Count:** ~200 functions
**Priority:** P3
**Target Coverage:** Protocol-level tests instead of unit tests

### 5. Dead Code (REMOVE)

**Definition:** Code that appears unreachable or unused.

**Examples:**
- Functions with no callers (identified via static analysis)
- Deprecated code paths
- Unused helpers

**Count:** ~50 functions (estimated)
**Priority:** P2 (cleanup task)
**Action:** Remove or document why kept

---

## Prioritized Test Plan

### Phase 2.1: Foundation (16h) ⬅️ **CURRENT**

- [x] Detailed coverage analysis ✅
- [ ] Design contract test framework (4h)
- [ ] Create integration test plan (4h)
- [ ] Set up coverage gates (4h)

### Phase 2.2: Plugin SDK Testing (24h)

**Goal:** 8.6% → 80%+ coverage

- [ ] Test plugin validation (6h)
- [ ] Test plugin lifecycle (6h)
- [ ] Test plugin communication (6h)
- [ ] Add SDK contract tests (6h)

### Phase 2.3: CLI Testing (20h)

**Goal:** 12.1% → 80%+ coverage

- [ ] Test command registration (5h)
- [ ] Test command execution (6h)
- [ ] Test error handling (5h)
- [ ] Test help system (4h)

### Phase 2.4: Core Package Testing (24h)

**Goal:** Bring all core packages to 80%+

- [ ] Test config package: 26.7% → 80%+ (6h)
- [ ] Test errors package: 38.6% → 80%+ (6h)
- [ ] Test output package: 35.3% → 80%+ (6h)
- [ ] Test prompt package: 6.0% → 80%+ (6h)

### Phase 2.5: Contract Tests (16h)

- [ ] Interface contract tests (8h)
- [ ] SDK contract tests (8h)

### Phase 2.6: Integration & E2E (20h)

- [ ] Expand integration tests (8h)
- [ ] Add E2E tests (8h)
- [ ] Add performance tests (4h)

**Total Effort:** 120 hours
**Expected Final Coverage:** 80%+

---

## Testing Strategy by Package

### Strategy 1: Plugin SDK (pkg/plugin/sdk/v1, pkg/plugin/sdk)

**Approach:**
1. **Contract Tests First** - Define expected behavior via interface contracts
2. **Integration Tests** - Test plugin loading and communication end-to-end
3. **Unit Tests** - Test individual functions with mocks
4. **Skip Generated Code** - Focus on hand-written code, not `.pb.go` files

**Key Techniques:**
- Mock gRPC clients/servers
- Docker container mocks (or use testcontainers)
- TTY emulation for interactive tests
- Signal handling tests with actual signals

**Challenges:**
- Platform-specific code (Unix vs Windows)
- Docker dependency
- TTY requirements

**Mitigation:**
- Build tags for platform-specific tests
- Docker testcontainers for reliable container tests
- PTY library for TTY emulation

### Strategy 2: CLI (internal/cli)

**Approach:**
1. **Command Tree Tests** - Verify command registration and hierarchy
2. **Execution Tests** - Test command execution with various inputs
3. **Error Path Tests** - Focus on error handling and messaging
4. **Integration Tests** - Test full command flows

**Key Techniques:**
- Capture stdout/stderr for assertions
- Mock dependencies (registry, config, context)
- Table-driven tests for command variations
- Error simulation

**Challenges:**
- Cobra command integration
- YAML command discovery
- Shell completion testing

### Strategy 3: Core Packages (config, errors, output, prompt)

**Approach:**
1. **Table-Driven Tests** - Use test tables for input/output variations
2. **Error Path Coverage** - Test all error conditions
3. **Edge Case Testing** - Boundary conditions, empty inputs, malformed data

**Key Techniques:**
- Testutil helpers (fixtures, assertions)
- Mock file system for config tests
- Buffer capture for output tests
- TTY emulation for prompt tests

---

## Gaps and Risks

### High-Risk Gaps

1. **Plugin Security** (pkg/plugin/sdk/v1)
   - **Risk:** Arbitrary code execution, path traversal
   - **Impact:** CRITICAL
   - **Mitigation:** Comprehensive security testing in Phase 2.2

2. **CLI Error Handling** (internal/cli)
   - **Risk:** Unhelpful error messages, crashes
   - **Impact:** HIGH
   - **Mitigation:** Error path testing in Phase 2.3.3

3. **Config Validation** (internal/config)
   - **Risk:** Config corruption, invalid state
   - **Impact:** HIGH
   - **Mitigation:** Validation testing in Phase 2.4.1

### Medium-Risk Gaps

4. **Output Formatting** (pkg/output)
   - **Risk:** Malformed output, broken JSON
   - **Impact:** MEDIUM
   - **Mitigation:** Format testing in Phase 2.4.3

5. **Interactive Sessions** (pkg/prompt)
   - **Risk:** Broken TTY handling, poor UX
   - **Impact:** MEDIUM (UI component)
   - **Mitigation:** Interactive testing in Phase 2.4.4

### Low-Risk Gaps

6. **Help System** (internal/cli/help.go)
   - **Risk:** Incomplete or confusing help
   - **Impact:** LOW (usability)
   - **Mitigation:** Help tests in Phase 2.3.4

---

## Dependencies and Blockers

### Test Infrastructure Dependencies

1. **Docker** - Required for plugin SDK tests
   - **Solution:** Use testcontainers-go for reliable Docker tests
   - **Fallback:** Skip Docker tests in CI if Docker unavailable

2. **TTY** - Required for interactive and prompt tests
   - **Solution:** Use pty library for PTY emulation
   - **Fallback:** Mock TTY interface for headless CI

3. **Shell Environment** - Required for completion tests
   - **Solution:** Use containerized shell environments
   - **Fallback:** Skip completion installation tests

### Code Dependencies

1. **Mock Implementations**
   - All needed mocks already created in `tests/testutil/mocks/`
   - No blockers

2. **Test Fixtures**
   - Need sample plugins for SDK tests
   - Need sample configs for config tests
   - **Action:** Create in Phase 2.2 and 2.4

---

## Success Metrics

### Coverage Metrics

- **Overall Coverage:** 26.8% → 80%+ (target: +53.2%)
- **Critical Packages:** All 7 packages >80%
- **New Code:** All new code >90% coverage

### Quality Metrics

- All tests passing (0 failures)
- No flaky tests (<1% flake rate)
- Test execution time <5 minutes total
- No skipped tests (except platform-specific)

### Process Metrics

- All PRs include tests
- Coverage gates enforced in CI
- Coverage visible in PR comments
- No coverage regressions

---

## Next Steps

1. ✅ **Complete Phase 2.1.1** - This coverage analysis
2. **Start Phase 2.1.2** - Design contract test framework
3. **Continue Phase 2.1** - Complete foundation tasks
4. **Execute Phase 2.2-2.6** - Systematic testing of all packages

---

## Appendix

### Detailed Coverage Data

**Full coverage report:** `docs/testing/coverage-detailed.txt`
**HTML coverage:** `docs/testing/coverage.html`
**Coverage profile:** `coverage.out`

### Commands

```bash
# Generate coverage
go test -coverprofile=coverage.out ./...

# View HTML report
go tool cover -html=coverage.out -o coverage.html

# Function-level coverage
go tool cover -func=coverage.out | sort -k3 -n

# Package-level coverage
go test ./... -cover | grep coverage
```

### References

- **Implementation Checklist:** `docs/specs/gold-standard-remediation/implementation-checklist.md`
- **Phase 2 Tasks:** Lines 2122-2803
- **Test Helpers:** `tests/testutil/README.md`
- **Mocks:** `tests/testutil/mocks/README.md`
