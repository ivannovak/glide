name: CI

# Note: This workflow does NOT run on pushes to main to avoid duplicate runs.
# The semantic-release workflow handles main branch and calls this workflow first.
on:
  push:
    branches: [develop]  # Only develop - semantic-release handles main branch
  pull_request:
    branches: [main]
  workflow_call:  # Called by semantic-release and release workflows

env:
  CACHE_VERSION: v1

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache.outputs.key }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: go mod download
      - run: go mod verify
      - id: cache
        run: echo "key=${{ runner.os }}-go-${{ hashFiles('go.mod') }}-${{ hashFiles('**/go.sum') }}" >> $GITHUB_OUTPUT

  lint:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8
      - name: Run golangci-lint
        # Note: Using || true temporarily until existing lint issues are remediated
        # TODO: Remove || true once lint issues are fixed in a separate PR
        run: $(go env GOPATH)/bin/golangci-lint run --timeout=5m --config=.golangci.yml || true
      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "The following files need formatting:"
            gofmt -s -l .
            exit 1
          fi
      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

  test-unit:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Needed for coverage diff
      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Run tests with coverage
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out

      - name: Check coverage gates
        run: |
          chmod +x scripts/check-coverage.sh
          ./scripts/check-coverage.sh

      - name: Generate coverage report
        if: github.event_name == 'pull_request'
        run: |
          echo "## üìä Coverage Report" > coverage-report.md
          echo "" >> coverage-report.md

          # Total coverage
          TOTAL=$(go tool cover -func=coverage.out | grep total: | awk '{print $3}')
          echo "**Total Coverage:** $TOTAL" >> coverage-report.md
          echo "" >> coverage-report.md

          # Critical packages
          echo "### Critical Packages" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "| Package | Coverage | Status |" >> coverage-report.md
          echo "|---------|----------|--------|" >> coverage-report.md

          for pkg in "pkg/plugin/sdk/v1" "pkg/plugin/sdk" "internal/cli" "pkg/prompt"; do
            COV=$(go tool cover -func=coverage.out | grep "github.com/glide-cli/glide/v3/${pkg}/" | \
              awk '{sum += $3; count++} END {if (count > 0) printf "%.1f%%", sum/count; else print "N/A"}')

            if [[ "$COV" == "N/A" ]]; then
              STATUS="‚ùì"
            elif (( $(echo "${COV%%%*} < 80" | bc -l 2>/dev/null || echo 1) )); then
              STATUS="‚ö†Ô∏è"
            else
              STATUS="‚úÖ"
            fi

            echo "| $pkg | $COV | $STATUS |" >> coverage-report.md
          done

          echo "" >> coverage-report.md
          echo "### High Priority Packages" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "| Package | Coverage | Status |" >> coverage-report.md
          echo "|---------|----------|--------|" >> coverage-report.md

          for pkg in "internal/config" "pkg/errors" "pkg/output"; do
            COV=$(go tool cover -func=coverage.out | grep "github.com/glide-cli/glide/v3/${pkg}/" | \
              awk '{sum += $3; count++} END {if (count > 0) printf "%.1f%%", sum/count; else print "N/A"}')

            if [[ "$COV" == "N/A" ]]; then
              STATUS="‚ùì"
            elif (( $(echo "${COV%%%*} < 80" | bc -l 2>/dev/null || echo 1) )); then
              STATUS="‚ö†Ô∏è"
            else
              STATUS="‚úÖ"
            fi

            echo "| $pkg | $COV | $STATUS |" >> coverage-report.md
          done

          echo "" >> coverage-report.md
          echo "**Target:** 80% for all packages" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "---" >> coverage-report.md
          echo "*Automated coverage report from Phase 2 Testing Infrastructure*" >> coverage-report.md

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true  # Don't fail job if PR comment fails (permissions issue)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          path: coverage-report.md

  test-integration:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: go test -tags=integration -timeout=60s ./tests/integration/...
      - run: go test -v -timeout=10m ./tests/e2e/...

  build-test:
    needs: validate
    strategy:
      fail-fast: true
      matrix:
        include:
          - {goos: linux, goarch: amd64}
          - {goos: darwin, goarch: amd64}
          - {goos: darwin, goarch: arm64}
          - {goos: windows, goarch: amd64}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true
      - run: |
          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
          go build -o test-binary ./cmd/glide

  security:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
      - uses: securego/gosec@master
        with:
          args: '-exclude=G104,G107,G204,G304,G301,G302,G306,G115 -severity=medium -confidence=medium -fmt sarif -out results.sarif ./...'
      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true  # SARIF upload requires GitHub Advanced Security
        with:
          sarif_file: results.sarif
