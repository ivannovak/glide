name: CI

# Note: This workflow does NOT run on pushes to main to avoid duplicate runs.
# The semantic-release workflow handles main branch and calls this workflow first.
on:
  push:
    branches: [develop]  # Only develop - semantic-release handles main branch
  pull_request:
    branches: [main]
  workflow_call:  # Called by semantic-release and release workflows

env:
  GO_VERSION: '1.24'
  CACHE_VERSION: v1

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache.outputs.key }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go mod download
      - run: go mod verify
      - id: cache
        run: echo "key=${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}" >> $GITHUB_OUTPUT

  lint:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
      - name: Run golangci-lint
        run: $(go env GOPATH)/bin/golangci-lint run --timeout=5m --config=.golangci.yml || true
        # Note: Using || true temporarily until .golangci.yml is configured
      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "The following files need formatting:"
            gofmt -s -l .
            exit 1
          fi
      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

  test-unit:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go test -race -coverprofile=coverage.out -covermode=atomic ./...
      - uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
      - name: Check test coverage
        run: |
          go tool cover -func=coverage.out
          COVERAGE=$(go tool cover -func=coverage.out | grep total: | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COVERAGE}%"
          # TODO: Increase minimum coverage as more tests are added
          if (( $(echo "$COVERAGE < 10" | bc -l) )); then
            echo "Coverage $COVERAGE% is below minimum 10%"
            exit 1
          fi

  test-integration:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go test -tags=integration -timeout=60s ./tests/integration/...
      - run: go test -v -timeout=10m ./tests/e2e/...

  build-test:
    needs: validate
    strategy:
      fail-fast: true
      matrix:
        include:
          - {goos: linux, goarch: amd64}
          - {goos: darwin, goarch: amd64}
          - {goos: darwin, goarch: arm64}
          - {goos: windows, goarch: amd64}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: |
          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
          go build -o test-binary ./cmd/glid

  security:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: securego/gosec@master
        with:
          args: '-exclude=G104,G204,G304,G301,G302,G306,G115 -severity=medium -confidence=medium -fmt sarif -out results.sarif ./...'
      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true  # SARIF upload requires GitHub Advanced Security
        with:
          sarif_file: results.sarif